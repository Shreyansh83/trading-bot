<!doctype html>
<html>
<head>
  <title>Historic Data - {{ symbol }} ({{ date }}, {{ resolution }})</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .signal-breakdown {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .indicator-contribution {
      margin: 5px 0;
      padding: 8px;
      border-radius: 4px;
    }
    .positive { background-color: #d4edda; border: 1px solid #c3e6cb; }
    .negative { background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .neutral { background-color: #e2e3e5; border: 1px solid #d6d8db; }
  </style>
</head>
<body class="p-4">
  <h1>Historic {{ resolution }} Data for {{ symbol }} on {{ date }}</h1>
  
  <div class="row">
    <div class="col-md-8">
      {% if chart_file %}
        <div class="mb-3">
          <h4>Chart Analysis</h4>
          <img src="{{ url_for('static', filename=chart_file) }}" class="img-fluid border rounded" />
        </div>
      {% endif %}
    </div>
    
    <div class="col-md-4">
      {% if signal_breakdown %}
      <div class="signal-breakdown">
        <h4>Final Signal Breakdown</h4>
        <p class="text-muted">Indicator contributions for the last candle</p>
        
        <div class="mb-3">
          <strong>Composite Score:</strong>
          <span class="{% if signal_breakdown.composite_score > 0 %}text-success{% elif signal_breakdown.composite_score < 0 %}text-danger{% else %}text-muted{% endif %}">
            {{ "%.3f"|format(signal_breakdown.composite_score) }}
          </span>
        </div>
        
        {% for indicator in ['rsi', 'macd', 'bb', 'ema', 'sar', 'supertrend'] %}
          {% if signal_breakdown.get(indicator + '_contribution') is not none %}
          <div class="indicator-contribution 
                      {% if signal_breakdown[indicator + '_contribution'] > 0 %}positive
                      {% elif signal_breakdown[indicator + '_contribution'] < 0 %}negative
                      {% else %}neutral{% endif %}">
            <strong>{{ indicator.upper() }}:</strong>
            <span class="float-end">{{ "%.3f"|format(signal_breakdown[indicator + '_contribution']) }}</span>
            <br>
            <small class="text-muted">
              Score: {{ "%.3f"|format(signal_breakdown.get(indicator + '_score', 0)) }}
            </small>
          </div>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
      
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Actions</h5>
          <a href="/weights?symbol={{ symbol }}" class="btn btn-outline-primary d-block mb-2">
            Adjust Weights for {{ symbol }}
          </a>
          <a href="/" class="btn btn-secondary d-block">
            Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <h4 class="mt-4">Detailed Data Table</h4>
  <div class="table-responsive">
    {% for table in tables %}{{ table|safe }}{% endfor %}
  </div>

  <script>
    // Make table more interactive
    document.addEventListener('DOMContentLoaded', function() {
      const table = document.querySelector('table');
      if (table) {
        table.classList.add('table-hover');
        
        // Highlight rows based on signal
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const signalCell = Array.from(row.cells).find(cell => 
            cell.textContent.includes('BUY') || 
            cell.textContent.includes('SELL') || 
            cell.textContent.includes('NEUTRAL')
          );
          
          if (signalCell) {
            if (signalCell.textContent.includes('BUY')) {
              row.classList.add('table-success');
            } else if (signalCell.textContent.includes('SELL')) {
              row.classList.add('table-danger');
            }
          }
        });
      }
    });
  </script>
</body>
</html>
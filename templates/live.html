<!doctype html>
<html>
<head>
  <title>Live Signal — {{ symbol }} ({{ resolution }})</title>
  <meta http-equiv="refresh" content="30;url={{ request.url }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .signal-breakdown {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .indicator-contribution {
      margin: 5px 0;
      padding: 8px;
      border-radius: 4px;
    }
    .positive { background-color: #d4edda; border: 1px solid #c3e6cb; }
    .negative { background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .neutral { background-color: #e2e3e5; border: 1px solid #d6d8db; }
  </style>
</head>
<body class="p-4">
  <h1>Live Signal for {{ symbol }} at {{ resolution }} Resolution</h1>

  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Current Status</h5>
          <p><strong>Last Update:</strong> {{ last_update }}</p>
          <p><strong>Current Price:</strong> ₹{{ price }}</p>
          <p>
            <strong>Signal:</strong>
            {% if signal is sameas true %}
              <span class="badge bg-success fs-6">BUY</span>
            {% elif signal is sameas false %}
              <span class="badge bg-danger fs-6">SELL</span>
            {% else %}
              <span class="badge bg-secondary fs-6">NEUTRAL</span>
            {% endif %}
          </p>
          <p><strong>Reason:</strong> {{ reason }}</p>
          
          {% if signal_breakdown %}
          <p><strong>Composite Score:</strong> 
            <span class="{% if signal_breakdown.composite_score > 0 %}text-success{% elif signal_breakdown.composite_score < 0 %}text-danger{% else %}text-muted{% endif %}">
              {{ "%.3f"|format(signal_breakdown.composite_score) }}
            </span>
          </p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Quick Actions</h5>
          <a href="/weights?symbol={{ symbol }}" class="btn btn-outline-primary">Adjust Weights</a>
          <a href="?{{ request.query_string.decode() }}&show_chart=on" class="btn btn-outline-info">
            {% if chart_file %}Refresh Chart{% else %}Show Chart{% endif %}
          </a>
          <button class="btn btn-outline-secondary" onclick="location.reload()">Refresh Data</button>
        </div>
      </div>
    </div>
  </div>

  {% if signal_breakdown %}
  <div class="signal-breakdown">
    <h4>Signal Breakdown</h4>
    <p class="text-muted">Individual indicator contributions to the final signal</p>
    
    <div class="row">
      {% for indicator in ['rsi', 'macd', 'bb', 'ema', 'sar', 'supertrend'] %}
        {% if signal_breakdown.get(indicator + '_contribution') is not none %}
        <div class="col-md-4 mb-2">
          <div class="indicator-contribution 
                      {% if signal_breakdown[indicator + '_contribution'] > 0 %}positive
                      {% elif signal_breakdown[indicator + '_contribution'] < 0 %}negative
                      {% else %}neutral{% endif %}">
            <strong>{{ indicator.upper() }}:</strong>
            <span class="float-end">{{ "%.3f"|format(signal_breakdown[indicator + '_contribution']) }}</span>
            <br>
            <small class="text-muted">
              Score: {{ "%.3f"|format(signal_breakdown.get(indicator + '_score', 0)) }}
            </small>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if chart_file %}
    <div class="mt-4">
      <h4>Chart Analysis</h4>
      <img src="{{ url_for('static', filename=chart_file) }}" class="img-fluid border rounded" />
    </div>
  {% endif %}

  <h4 class="mt-4">Recent Indicator Values</h4>
  <div class="table-responsive">
    {{ table_html|safe }}
  </div>

  <div class="mt-3">
    <a href="/" class="btn btn-secondary">Back to Dashboard</a>
    <a href="/weights" class="btn btn-outline-primary">Manage Weights</a>
  </div>

  <script>
    // Auto-refresh control
    let refreshInterval = 30; // seconds
    let countdown = refreshInterval;
    
    function updateCountdown() {
      document.title = `Live Signal (${countdown}s) — {{ symbol }} ({{ resolution }})`;
      countdown--;
      if (countdown < 0) countdown = refreshInterval;
    }
    
    setInterval(updateCountdown, 1000);
  </script>
</body>
</html>